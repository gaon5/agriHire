{% extends "base.html" %}


{% block mytitle %}
    Shopping Cart
{% endblock %}


{% block mycss %}
    <style>
        .cart-title {
            color: #1D1912; /* 字体颜色 */
            font-family: 'Poppins', sans-serif; /* 字体 */
            font-size: 24px; /* 字体大小 */
            margin-left: 15%; /* 左侧距离 */
            margin-right: 15%; /* 右侧距离 */
            border-bottom: 3px solid #1D1912; /* 3px深色横线 */
            padding-bottom: 10px; /* 为了使横线与文字之间有些间距 */
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            background-color: #e5e5e5;
            border-bottom: 1px solid #1D1912;
            font-weight: bold;
        }

        .header-cell {
            text-align: center;
        }

        .header-cell:nth-child(1) {
            flex: 3;

        }

        .header-cell:nth-child(2) {
            flex: 1;

        }

        .header-cell:nth-child(3) {
            flex: 2;

        }

        .header-cell:nth-child(4) {
            flex: 2;

        }

        .header-cell:nth-child(5) {
            flex: 2;

        }

        .header-cell:nth-child(6) {
            flex: 1;

        }

        .header-cell:nth-child(7) {
            flex: 1;

        }

        .quantity-btn {
            border: none; /* 移除按钮的边框 */
            background-color: transparent; /* 透明背景 */
            color: #1D1912; /* 修改字体颜色 */
            cursor: pointer; /* 更改光标样式为pointer */
        }

        .quantity-btn:hover {
            background-color: #eacd76; /* 设置鼠标hover时的背景颜色 */
        }

        .total-bar {
            display: flex;
            justify-content: space-between; /* 将内容分布在两端，而不仅仅是右侧 */
            padding: 10px 0;
            border-top: 2px solid #1D1912;
        }

        .total-price {
            margin-right: 15%; /* 与页面右侧对齐 */
            font-size: 24px; /* 字体大小 */
            font-weight: bold; /* 粗体字 */
            font-family: 'Poppins', sans-serif;
        }

        .total-amount {
            font-size: 24px; /* 字体大小 */
            font-weight: bold; /* 粗体字 */
            font-family: 'Poppins', sans-serif;
        }

    </style>

{% endblock %}


{% block body %}
    <div>
        <p class="cart-title">
            My Shopping Cart
        </p>

        <div style="margin-left: 15%; margin-right: 15%;">

            <div class="table-header">
                <div class="header-cell">My Equipment</div>
                <div class="header-cell">Quantity</div>
                <div class="header-cell">Rental Date</div>
                <div class="header-cell">Estimate Return Date</div>
                <div class="header-cell">Item Price</div>
                <div class="header-cell">Edit</div>
                <div class="header-cell">Delete</div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        {% for equipment in equipment_list %}
                            <div class="col-md-3 d-flex align-items-center">
                                <img src="{{ url_for('static', filename=equipment.image_url) }}" alt="Equipment Image" class="img-fluid"
                                     style="max-width: 80px;">
                                <span style="max-width: 200px; word-wrap: break-word; margin-left: 15px;">{{ equipment.name }}</span>
                                <input type="hidden" id="cart_item_id" name="cart_item_id" value="{{ equipment.cart_item_id }}">
                            </div>
                            <div class="col-md-1 d-flex align-items-center justify-content-center">
                                <button class="quantity-btn" onclick="decrementQuantity({{ loop.index }})">-</button>
                                <input type="number" id="quantityInput_{{ loop.index }}" data-max-count="{{ equipment.count }}" value="1" min="1"
                                       max="{{ equipment.count }}" style="width: 50px; text-align: center; margin: 0 5px;">
                                <button class="quantity-btn" onclick="incrementQuantity({{ loop.index }})">+</button>
                            </div>
                            <div class="col-md-2 d-flex align-items-center justify-content-center">
                                <span id="startTime_{{ loop.index }}" data-start-time="{{ equipment.start_time }}">{{ equipment.start_time }}</span>
                            </div>
                            <div class="col-md-2 d-flex align-items-center justify-content-center">
                                <span id="endTime_{{ loop.index }}" data-end-time="{{ equipment.end_time }}">{{ equipment.end_time }}</span>
                            </div>
                            <div class="col-md-2 d-flex align-items-center justify-content-center">
                                <span id="itemPrice_{{ loop.index }}" data-original-price="{{ equipment.price }}">{{ equipment.price }}</span>
                            </div>

                            <div class="col-md-1 d-flex align-items-center justify-content-center">
                                <a href="#" class="btn btn-primary" style="font-size: 14px" data-bs-toggle="modal" data-bs-target="#editModal"
                                   onclick="openEditModal({{ loop.index }})">Edit</a>
                            </div>

                            <div class="col-md-1 d-flex align-items-center justify-content-center">
                                <a href="/delete_item?cart_item_id={{ equipment.cart_item_id }}" class="btn btn-danger" style="font-size: 14px">Delete</a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="total-bar">
                <span class="total-price">Total Price: </span>
                <span class="total-amount">{{ total_amount }} </span>
                <form action="{{ url_for('payment') }}" method="get">
                    <button type="submit" class="btn btn-primary">Next Step</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Rental Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Quantity Input -->
                    <div class="mb-3">
                        <label for="Quantity" class="form-label">Quantity</label>
                        <div style="display: flex; align-items: center;">
                            <button class="quantity-btn" onclick="decrementModalQuantity()">-</button>
                            <input type="text" class="form-control" id="Quantity" value="1" readonly
                                   style="width: 60px; text-align: center; margin: 0 5px;">
                            <button class="quantity-btn" onclick="incrementModalQuantity()">+</button>
                        </div>
                    </div>
                    <!-- Date Input -->
                    <div class="mb-3">
                        <label for="Rental Date" class="form-label">Rental Date</label>
                        <input type="text" id="start_time_updated" name="start_time" placeholder="Rental Date & Time">
                    </div>
                    <div class="mb-3">
                        <label for="Return Date" class="form-label">Return Date</label>
                        <input type="text" id="end_time_updated" name="end_time" placeholder="Return Date & Time">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveChanges()">Save changes</button>
                </div>
            </div>
        </div>
    </div>


{% endblock %}


{% block myjs %}
    <script>
        let currentIndex;

        function decrementQuantity(index) {
            let input = document.getElementById('quantityInput_' + index);
            let currentValue = parseInt(input.value, 10);
            if (currentValue > 1) {
                input.value = currentValue - 1;
                updateItemPrice(index);
            }
        }

        function incrementQuantity(index) {
            let input = document.getElementById('quantityInput_' + index);
            let currentValue = parseInt(input.value, 10);
            let maxCount = parseInt(input.getAttribute('data-max-count'), 10);

            if (currentValue < maxCount) {
                input.value = currentValue + 1;
                updateItemPrice(index);
            }
        }

        function updateItemPrice(index) {
            let quantityInput = document.getElementById('quantityInput_' + index);
            let priceElement = document.getElementById('itemPrice_' + index);

            let originalPrice = parseFloat(priceElement.getAttribute('data-original-price'));
            let quantity = parseInt(quantityInput.value, 10);

            let totalPriceForItem = originalPrice * quantity;
            priceElement.textContent = totalPriceForItem.toFixed(2);  // 显示两位小数的价格

            updateTotalAmount();
        }

        function updateTotalAmount() {
            let total = 0;
            let items = document.querySelectorAll('[id^="itemPrice_"]');  // 选择所有以 "itemPrice_" 开头的ID的元素

            items.forEach(item => {
                total += parseFloat(item.textContent);
            });

            // 将总计更新到.total-amount元素
            document.querySelector('.total-amount').textContent = total.toFixed(2);
        }

        flatpickr("#start_time_updated", {
            enableTime: true, // 启用时间选择
            noCalendar: false, // 显示日期选择器
            dateFormat: "d-m-Y H:i", // 更新日期格式以包括小时和分钟
            time_24hr: true, // 使用24小时制时间格式
            disable: ["2023-10-30", "2023-10-10"], //可以添加为设备租借完了的日子
            minDate: new Date().fp_incr(1),
            maxDate: new Date().fp_incr(91),
        });

        flatpickr("#end_time_updated", {
            enableTime: true, // 启用时间选择
            noCalendar: false, // 显示日期选择器
            dateFormat: "d-m-Y H:i", // 更新日期格式以包括小时和分钟
            time_24hr: true, // 使用24小时制时间格式
            disable: ["2023-10-30", "2023-10-10"],
            minDate: new Date().fp_incr(1),
            maxDate: new Date().fp_incr(91),
        });

        function decrementModalQuantity() {
            let input = document.getElementById('Quantity');
            let currentValue = parseInt(input.value, 10);
            if (currentValue > 1) {
                input.value = currentValue - 1;
            }
        }

        function incrementModalQuantity() {
            let input = document.getElementById('Quantity');
            let maxCount = parseInt(document.querySelector("#quantityInput_" + currentIndex).getAttribute('data-max-count'), 10);
            let currentValue = parseInt(input.value, 10);
            if (currentValue < maxCount) {
                input.value = currentValue + 1;
            }
        }

        function openEditModal(index) {
            currentIndex = index;
            let quantityInput = document.getElementById('quantityInput_' + index);
            let start_time = document.getElementById('startTime_' + index);
            let end_time = document.getElementById('endTime_' + index);

            // 设置模态框中的输入值
            document.getElementById('Quantity').value = quantityInput.value;
            document.getElementById('start_time_updated').value = start_time.textContent;
            document.getElementById('end_time_updated').value = end_time.textContent;

            // 步骤二的代码
            let modalQuantityInput = document.getElementById('Quantity');
            let maxCount = parseInt(quantityInput.getAttribute('data-max-count'), 10);
            modalQuantityInput.setAttribute('min', '1');
            modalQuantityInput.setAttribute('max', maxCount.toString());
        }

        function saveChanges() {
            let cart_item_id = document.getElementById('cart_item_id').value;
            let quantity = document.getElementById('Quantity').value;
            let start_time = document.getElementById('start_time_updated').value
            let end_time = document.getElementById('end_time_updated').value;

            // 使用fetch或XMLHttpRequest向服务器发送数据
            fetch('/edit_details', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cart_item_id: cart_item_id,
                    quantity: quantity,
                    start_time: start_time,
                    end_time: end_time
                })
            })
                .then(response => response.json())
                .then(data => {
                    // 处理服务器的响应，例如更新页面
                });
        }

        // 监听模态框上的保存按钮点击事件
        document.querySelector('#editModal .btn-primary').addEventListener('click', saveChanges);

    </script>

{% endblock %}